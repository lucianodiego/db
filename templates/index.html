<!DOCTYPE html>
<html lang="it">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Ricerca Anagrafica</title>
    <style>
        body { font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif; line-height: 1.6; margin: 0; background-color: #f4f4f9; color: #333; }
        .container { max-width: 1200px; margin: 20px auto; padding: 20px; background-color: #fff; border-radius: 8px; box-shadow: 0 2px 10px rgba(0,0,0,0.1); }
        h1, h2, h3 { color: #2c3e50; border-bottom: 2px solid #e0e0e0; padding-bottom: 10px; }
        .info-bar { display: flex; justify-content: space-between; align-items: center; padding-bottom: 10px; flex-wrap: wrap; gap: 15px; }
        .alphabet-bar { margin: 20px 0; padding: 10px; background-color: #ecf0f1; border-radius: 5px; text-align: center; }
        .alphabet-bar a { margin: 0 5px; text-decoration: none; color: #3498db; font-weight: bold; }
        .alphabet-bar a.active { color: #e74c3c; text-decoration: underline; }
        form, .results-info, .upload-section { margin-bottom: 20px; padding: 20px; border: 1px solid #e0e0e0; border-radius: 8px; }
        .form-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(300px, 1fr)); gap: 20px; }
        .form-group { display: flex; flex-direction: column; }
        .form-group label { font-weight: bold; margin-bottom: 5px; }
        .form-group input[type="text"], .form-group input[type="number"], .form-group select { padding: 10px; border: 1px solid #ccc; border-radius: 4px; font-size: 1rem; width: 100%; box-sizing: border-box; }
        .radio-group { display: flex; gap: 15px; margin-top: 10px; }
        .radio-group label { font-weight: normal; }
        .button-group { grid-column: 1 / -1; display: flex; justify-content: flex-start; gap: 10px; margin-top: 20px; }
        button { padding: 10px 20px; border: none; border-radius: 4px; background-color: #3498db; color: white; font-size: 1rem; cursor: pointer; transition: background-color 0.3s; }
        button:hover { background-color: #2980b9; }
        button.secondary { background-color: #95a5a6; }
        button.secondary:hover { background-color: #7f8c8d; }
        table { width: 100%; border-collapse: collapse; margin-top: 20px; }
        th, td { padding: 12px; border: 1px solid #ddd; text-align: left; }
        th { background-color: #f2f2f2; }
        th a { text-decoration: none; color: inherit; }
        .pagination { display: flex; justify-content: center; align-items: center; gap: 5px; margin-top: 20px; flex-wrap: wrap; }
        .pagination a, .pagination span { padding: 8px 12px; border: 1px solid #ddd; text-decoration: none; color: #3498db; }
        .pagination .active { background-color: #3498db; color: white; border-color: #3498db; }
        .flash-messages { list-style: none; padding: 0; margin-bottom: 20px; }
        .flash-messages li { padding: 15px; border-radius: 5px; margin-bottom: 10px; border: 1px solid; }
        .flash-success { background-color: #d4edda; color: #155724; border-color: #c3e6cb; }
        .flash-danger { background-color: #f8d7da; color: #721c24; border-color: #f5c6cb; }
        .flash-warning { background-color: #fff3cd; color: #856404; border-color: #ffeeba; }
        .flash-info { background-color: #d1ecf1; color: #0c5460; border-color: #bee5eb; }
        .upload-section { background-color: #f8f9fa; }
        .results-header { display: flex; justify-content: space-between; align-items: center; flex-wrap: wrap; gap: 15px; }
        .validation-error { color: #721c24; background-color: #f8d7da; border: 1px solid #f5c6cb; padding: 15px; border-radius: 5px; margin-top: 20px; }
    </style>
</head>
<body>
    <div class="container">
        <h1>Ricerca Anagrafica</h1>
        <div class="info-bar">
            <span>Record totali nel database: <strong>{{ total_record_count }}</strong></span>
            <span>Ultimo aggiornamento: <strong>{{ last_update_date }}</strong></span>
        </div>

        {% with messages = get_flashed_messages(with_categories=true) %}
            {% if messages %}
                <ul class="flash-messages">
                {% for category, message in messages %}
                    <li class="flash-{{ category }}">{{ message }}</li>
                {% endfor %}
                </ul>
            {% endif %}
        {% endwith %}

        <form method="post">
            <h3>Filtri di Ricerca</h3>
            <div class="form-grid">
                <div class="form-group">
                    <label for="cognome_testo">Cognome</label>
                    <input type="text" name="cognome_testo" id="cognome_testo" value="{{ search_params.cognome_testo }}">
                    <div class="radio-group">
                        <label><input type="radio" name="cognome_tipo" value="inizia" {% if search_params.cognome_tipo == 'inizia' %}checked{% endif %}> Inizia con</label>
                        <label><input type="radio" name="cognome_tipo" value="contiene" {% if search_params.cognome_tipo == 'contiene' %}checked{% endif %}> Contiene</label>
                        <label><input type="radio" name="cognome_tipo" value="esatto" {% if search_params.cognome_tipo == 'esatto' %}checked{% endif %}> Esatto</label>
                    </div>
                </div>
                <div class="form-group">
                    <label for="nome_testo">Nome</label>
                    <input type="text" name="nome_testo" id="nome_testo" value="{{ search_params.nome_testo }}">
                    <div class="radio-group">
                        <label><input type="radio" name="nome_tipo" value="inizia" {% if search_params.nome_tipo == 'inizia' %}checked{% endif %}> Inizia con</label>
                        <label><input type="radio" name="nome_tipo" value="contiene" {% if search_params.nome_tipo == 'contiene' %}checked{% endif %}> Contiene</label>
                        <label><input type="radio" name="nome_tipo" value="esatto" {% if search_params.nome_tipo == 'esatto' %}checked{% endif %}> Esatto</label>
                    </div>
                </div>
                <div class="form-group">
                    <label for="data_nascita_anno">Anno di Nascita</label>
                    <input type="text" name="data_nascita_anno" id="data_nascita_anno" value="{{ search_params.data_nascita_anno }}" placeholder="Es: 1990">
                     <div class="radio-group">
                        <label><input type="radio" name="data_nascita_tipo" value="anno_esatto" {% if search_params.data_nascita_tipo == 'anno_esatto' %}checked{% endif %}> Esatto</label>
                        <label><input type="radio" name="data_nascita_tipo" value="pm_1" {% if search_params.data_nascita_tipo == 'pm_1' %}checked{% endif %}> +/- 1 anno</label>
                        <label><input type="radio" name="data_nascita_tipo" value="pm_5" {% if search_params.data_nascita_tipo == 'pm_5' %}checked{% endif %}> +/- 5 anni</label>
                    </div>
                </div>
                 <div class="form-group">
                    <label for="nome_padre_testo">Nome del Padre</label>
                    <input type="text" name="nome_padre_testo" id="nome_padre_testo" value="{{ search_params.nome_padre_testo }}">
                    <div class="radio-group">
                        <label><input type="radio" name="nome_padre_tipo" value="inizia" {% if search_params.nome_padre_tipo == 'inizia' %}checked{% endif %}> Inizia con</label>
                        <label><input type="radio" name="nome_padre_tipo" value="contiene" {% if search_params.nome_padre_tipo == 'contiene' %}checked{% endif %}> Contiene</label>
                        <label><input type="radio" name="nome_padre_tipo" value="esatto" {% if search_params.nome_padre_tipo == 'esatto' %}checked{% endif %}> Esatto</label>
                    </div>
                </div>
                <div class="form-group">
                    <label for="nome_madre_testo">Nome della Madre</label>
                    <input type="text" name="nome_madre_testo" id="nome_madre_testo" value="{{ search_params.nome_madre_testo }}">
                    <div class="radio-group">
                        <label><input type="radio" name="nome_madre_tipo" value="inizia" {% if search_params.nome_madre_tipo == 'inizia' %}checked{% endif %}> Inizia con</label>
                        <label><input type="radio" name="nome_madre_tipo" value="contiene" {% if search_params.nome_madre_tipo == 'contiene' %}checked{% endif %}> Contiene</label>
                        <label><input type="radio" name="nome_madre_tipo" value="esatto" {% if search_params.nome_madre_tipo == 'esatto' %}checked{% endif %}> Esatto</label>
                    </div>
                </div>
            </div>
            <div class="button-group">
                <button type="submit">Cerca</button>
                <button type="button" onclick="window.location.href='/'" class="secondary">Azzera Ricerca</button>
            </div>
        </form>

        <div class="upload-section">
            <h3>Carica nuovi dati da file CSV</h3>
            <form action="{{ url_for('upload_csv') }}" method="post" enctype="multipart/form-data">
                <p>Il caricamento di un nuovo file <strong>sostituirà tutti i dati esistenti</strong>.</p>
                <input type="file" name="csv_file" accept=".csv" required>
                <button type="submit">Carica e Sostituisci Dati</button>
            </form>
        </div>

        {% if validation_error %}
            <div class="validation-error">{{ validation_error }}</div>
        {% endif %}

        {% if is_search_active and not validation_error %}
            <div class="alphabet-bar">
                {% for letter in alphabet %}
                    <a href="{{ url_for('index', **search_params, letter=letter, page=1) }}" class="{% if search_params.letter == letter %}active{% endif %}">{{ letter }}</a>
                {% endfor %}
                <a href="{{ url_for('index', **search_params, letter='', page=1) }}" style="margin-left: 15px; color: #c0392b;">Azzera Lettera</a>
            </div>

            <div class="results-header">
                <div class="results-info">
                    Trovati <strong>{{ total_results }}</strong> risultati. 
                    {% if risultati %} Visualizzati da {{ start_result }} a {{ end_result }}. {% endif %}
                </div>
                <form method="get" class="per-page-form">
                    {% for key, value in search_params.items() %}{% if key != 'per_page' and key != 'page' %}<input type="hidden" name="{{ key }}" value="{{ value }}">{% endif %}{% endfor %}
                    <label for="per_page">Risultati per pagina:</label>
                    <select name="per_page" id="per_page" onchange="this.form.submit()">
                        <option value="10" {% if search_params.per_page == 10 %}selected{% endif %}>10</option>
                        <option value="20" {% if search_params.per_page == 20 %}selected{% endif %}>20</option>
                        <option value="50" {% if search_params.per_page == 50 %}selected{% endif %}>50</option>
                    </select>
                </form>
            </div>

            {% if risultati %}
                <table>
                    <thead>
                        <tr>
                            <th><a href="{{ url_for('index', **search_params, sort_by='cognome', sort_order='asc' if search_params.sort_by != 'cognome' or search_params.sort_order == 'desc' else 'desc') }}">Cognome {% if search_params.sort_by == 'cognome' %}{{ '▲' if search_params.sort_order == 'asc' else '▼' }}{% endif %}</a></th>
                            <th><a href="{{ url_for('index', **search_params, sort_by='nome', sort_order='asc' if search_params.sort_by != 'nome' or search_params.sort_order == 'desc' else 'desc') }}">Nome {% if search_params.sort_by == 'nome' %}{{ '▲' if search_params.sort_order == 'asc' else '▼' }}{% endif %}</a></th>
                            <th>Luogo di Nascita</th>
                            <th><a href="{{ url_for('index', **search_params, sort_by='data_nascita', sort_order='asc' if search_params.sort_by != 'data_nascita' or search_params.sort_order == 'desc' else 'desc') }}">Data di Nascita {% if search_params.sort_by == 'data_nascita' %}{{ '▲' if search_params.sort_order == 'asc' else '▼' }}{% endif %}</a></th>
                            <th><a href="{{ url_for('index', **search_params, sort_by='nome_padre', sort_order='asc' if search_params.sort_by != 'nome_padre' or search_params.sort_order == 'desc' else 'desc') }}">Padre {% if search_params.sort_by == 'nome_padre' %}{{ '▲' if search_params.sort_order == 'asc' else '▼' }}{% endif %}</a></th>
                            <th><a href="{{ url_for('index', **search_params, sort_by='nome_madre', sort_order='asc' if search_params.sort_by != 'nome_madre' or search_params.sort_order == 'desc' else 'desc') }}">Madre {% if search_params.sort_by == 'nome_madre' %}{{ '▲' if search_params.sort_order == 'asc' else '▼' }}{% endif %}</a></th>
                        </tr>
                    </thead>
                    <tbody>
                        {% for persona in risultati %}
                        <tr>
                            <td>{{ persona.cognome }}</td>
                            <td>{{ persona.nome }}</td>
                            <td>Disponibile*</td>
                            <td>{{ persona.data_nascita | format_date }}</td>
                            <td>{{ persona.nome_padre }}</td>
                            <td>{{ persona.nome_madre }}</td>
                        </tr>
                        {% endfor %}
                    </tbody>
                </table>
                
                {% if total_pages > 1 %}
                <div class="pagination">
                    <span>Pagina {{ page }} di {{ total_pages }}</span>
                    {% if page > 1 %}<a href="{{ url_for('index', page=page-1, **search_params) }}">&laquo; Precedente</a>{% endif %}
                    {% for p in range(1, total_pages + 1) %}
                        {% if p == page %}<span class="active">{{ p }}</span>
                        {% elif p - page < 3 and p - page > -3 %}<a href="{{ url_for('index', page=p, **search_params) }}">{{ p }}</a>
                        {% elif p == 1 or p == total_pages %}<a href="{{ url_for('index', page=p, **search_params) }}">{{ p }}</a>
                        {% elif p == 2 or p == total_pages -1 %}<span>...</span>
                        {% endif %}
                    {% endfor %}
                    {% if page < total_pages %}<a href="{{ url_for('index', page=page+1, **search_params) }}">Successivo &raquo;</a>{% endif %}
                </div>
                {% endif %}
            {% else %}
                <p>Nessun risultato trovato per la tua ricerca.</p>
            {% endif %}
        {% endif %}
    </div>
</body>
</html>
